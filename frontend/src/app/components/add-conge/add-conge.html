<div class="modal-container-conge">
  <div class="modal-header-conge">
    <h4 class="modal-title-conge">
      <i class="fas me-2" [ngClass]="mode()==='create' ? 'fa-plane-departure' : 'fa-edit'"></i>
      {{ mode() === 'create' ? 'Enregistrement d\'un congé' : 'Modification du congé' }}
    </h4>
    <button type="button" class="btn-close-conge" (click)="cancel()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <form class="modal-content-conge" [formGroup]="form">
    @if (submitError()) {
      <div class="submit-error-conge">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ submitError() }}
      </div>
    }

    <!-- Section Informations congé -->
    <div class="form-section-conge">
      <h6 class="section-label-conge">Informations du congé</h6>

      <div class="form-grid-conge">
        <!-- Contrat -->
        <div class="form-field-conge">
          <label class="field-label-conge">
            Contrat <span class="required-mark-conge">*</span>
          </label>
          <select class="field-select-conge"
                  formControlName="contrat_id"
                  [disabled]="mode()==='edit'"
                  [class.input-error-conge]="contrat_id.invalid && contrat_id.touched">
            <option [ngValue]="null" disabled>— Sélectionner —</option>
            @for (c of contratsCh(); track c.id) {
              <option [ngValue]="c.id">{{ contratLabel(c) }}</option>
            }
          </select>
          @if (contrat_id.touched && contrat_id.invalid) {
            <div class="field-error-conge">
              @if (contrat_id.hasError('required')) { Le contrat est obligatoire. }
            </div>
          }
        </div>

        <!-- Date début -->
        <div class="form-field-conge">
          <label class="field-label-conge">
            Date de début <span class="required-mark-conge">*</span>
          </label>
          <input type="date"
                 class="field-input-conge"
                 formControlName="date_debut"
                 [class.input-error-conge]="date_debut.invalid && date_debut.touched">
          @if (date_debut.touched && date_debut.invalid) {
            <div class="field-error-conge">
              @if (date_debut.hasError('required')) { La date de début est obligatoire. }
            </div>
          }
        </div>

        <!-- Nombre de jours -->
        <div class="form-field-conge">
          <label class="field-label-conge">
            Nombre de jours <span class="required-mark-conge">*</span>
          </label>
          <input type="number"
                 min="1"
                 class="field-input-conge"
                 formControlName="nb_jour"
                 [class.input-error-conge]="nb_jour.invalid && nb_jour.touched">
          @if (nb_jour.touched && nb_jour.invalid) {
            <div class="field-error-conge">
              @if (nb_jour.hasError('required')) { Le nombre de jours est obligatoire. }
              @if (nb_jour.hasError('min')) { Le nombre de jours doit être ≥ 1. }
            </div>
          }
        </div>

        <!-- Date fin (calculée automatiquement) -->
        <div class="form-field-conge">
          <label class="field-label-conge">Date de fin</label>
          <input type="date"
                 class="field-input-conge"
                 formControlName="date_fin"
                 >
        </div>

        <!-- Date reprise (calculée automatiquement) -->
        <div class="form-field-conge">
          <label class="field-label-conge">Date de reprise</label>
          <input type="date"
                 class="field-input-conge"
                 formControlName="date_reprise"
                 >
        </div>

        <!-- Statut (uniquement en édition) -->
        @if (mode() === 'edit') {
          <div class="form-field-conge">
            <label class="field-label-conge">
              Statut <span class="required-mark-conge">*</span>
            </label>
            <select class="field-select-conge"
                    formControlName="statut"
                    [class.input-error-conge]="statut.invalid && statut.touched">
              <option [ngValue]="null" disabled>— Sélectionner —</option>
              <option value="en_attente">En attente</option>
              <option value="approuve">Approuvé</option>
              <option value="rejete">Rejeté</option>
              <option value="annule">Annulé</option>
              <option value="termine">Terminé</option>
            </select>
          </div>
        }

        <!-- Motif (facultatif) - Span sur 2 colonnes -->
        <div class="form-field-conge form-field-full-conge">
          <label class="field-label-conge">Motif (facultatif)</label>
          <textarea class="field-textarea-conge"
                    formControlName="motif_conge"
                    rows="3"
                    placeholder="Ex: Congé annuel, motif personnel…"
                    [class.input-error-conge]="motif_conge.touched && motif_conge.invalid"></textarea>
          @if (motif_conge.touched && motif_conge.invalid) {
            <div class="field-error-conge">
              @if (motif_conge.hasError('maxlength')) { 500 caractères maximum. }
              @else if (motif_conge.hasError('pattern')) { Uniquement lettres, chiffres et ponctuation simple. }
              @else if (motif_conge.hasError('unsafeChars')) { Caractères < et > interdits. }
            </div>
          }
        </div>
      </div>
    </div>
  </form>

  <div class="modal-footer-conge">
    <button type="button" class="btn-cancel-conge" (click)="cancel()">
      <i class="fas fa-times me-1"></i>
      Annuler
    </button>
    <button type="button"
            class="btn-save-conge"
            (click)="submit()"
            [disabled]="form.invalid || isSubmitting()">
      @if (isSubmitting()) {
        <span class="spinner-border spinner-border-sm me-1"></span>
        Enregistrement...
      } @else {
        <i class="fas fa-save me-1"></i>
        Enregistrer
      }
    </button>
  </div>
</div>

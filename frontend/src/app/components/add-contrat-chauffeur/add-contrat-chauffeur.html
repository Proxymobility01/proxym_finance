<div class="modal-container-contrat">
  <div class="modal-header-contrat">
    <h4 class="modal-title-contrat">
      <i class="fas fa-file-contract me-2"></i>
      {{ mode() === 'edit' ? 'Modification Contrat Chauffeur' : 'Création Contrat Chauffeur' }}
    </h4>
    <button type="button" class="btn-close-contrat" (click)="cancel()">
      <i class="fas fa-times"></i>
    </button>
  </div>


  <form class="modal-content-contrat" [formGroup]="form">
    @if (submitError()) {
      <div class="field-error-contrat mt-2">
        <i class="fas fa-exclamation-triangle me-1"></i>
        {{ submitError() }}
      </div>
    }
    <!-- Section Liaisons -->
    <div class="form-section-contrat">
      <h6 class="section-label-contrat">Informations de liaison</h6>

      <div class="form-grid-3-contrat">
        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Association User–Moto <span class="required-mark-contrat">*</span>
          </label>
          <select class="field-select-contrat"
                  formControlName="association_user_moto_id"
                  [class.input-error-contrat]="aum.invalid && aum.touched">
            <option [ngValue]="null" disabled>— Sélectionner —</option>
            @for (opt of associationOptions(); track opt.id) {
              <option [ngValue]="opt.id">{{ opt.label }}</option>
            }
          </select>
          @if (aum.touched && aum.invalid) {
            <div class="field-error-contrat">Champ requis.</div>
          }
        </div>

        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Garant <span class="required-mark-contrat">*</span>
          </label>
          <select class="field-select-contrat"
                  formControlName="garant_id"
                  [class.input-error-contrat]="garant.invalid && garant.touched">
            <option [ngValue]="null" disabled>— Sélectionner —</option>
            @for (opt of garantOptions(); track opt.id) {
              <option [ngValue]="opt.id">{{ opt.label }}</option>
            }
          </select>
          @if (garant.touched && garant.invalid) {
            <div class="field-error-contrat">Champ requis.</div>
          }
        </div>

        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Contrat Batterie <span class="required-mark-contrat">*</span>
          </label>
          <select class="field-select-contrat"
                  formControlName="contrat_batt_id"
                  [class.input-error-contrat]="batt.invalid && batt.touched">
            <option [ngValue]="null" disabled>— Sélectionner —</option>
            @for (opt of battOptions(); track opt.id) {
              <option [ngValue]="opt.id">{{ opt.label }}</option>
            }
          </select>
          @if (batt.touched && batt.invalid) {
            <div class="field-error-contrat">Champ requis.</div>
          }
        </div>
      </div>
    </div>

    <!-- Section Montants -->
    <div class="form-section-contrat">
      <h6 class="section-label-contrat">Informations financières</h6>

      <div class="form-grid-4-contrat">
        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Montant total <span class="required-mark-contrat">*</span>
          </label>
          <div class="input-currency-contrat">
            <input type="text"
                   formControlName="montant_total"
                   class="field-input-contrat"
                   placeholder="1 302 000"
                   [class.input-error-contrat]="total.invalid && total.touched">
            <span class="currency-suffix">FCFA</span>
          </div>
          @if (total.touched && total.invalid) {
            <div class="field-error-contrat">
              @if (total.hasError('required')) { Champ requis. }
              @else if (total.hasError('pattern')) { Format: 1000, 1 000, 1 000.50 }
              @else if (total.hasError('maxlength')) { Valeur trop longue. }
            </div>
          }
        </div>

        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Montant engagé
          </label>
          <div class="input-currency-contrat">
            <input type="text"
                   formControlName="montant_engage"
                   class="field-input-contrat"
                   placeholder="5 000"
                   [class.input-error-contrat]="(engage.invalid && engage.touched) || form.hasError('engageAboveTotal')">
            <span class="currency-suffix">FCFA</span>
          </div>
          @if (engage.touched && engage.invalid) {
            <div class="field-error-contrat">
              @if (engage.hasError('pattern')) { Format: 1000, 1 000, 1 000.50 }
              @else if (engage.hasError('maxlength')) { Valeur trop longue. }
            </div>
          }
          @if (form.hasError('engageAboveTotal')) {
            <div class="field-error-contrat">Le montant engagé ne peut pas dépasser le montant total.</div>
          }
        </div>

        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Montant par paiement <span class="required-mark-contrat">*</span>
          </label>
          <div class="input-currency-contrat">
            <input type="text"
                   formControlName="montant_par_paiement"
                   class="field-input-contrat"
                   placeholder="5 000"
                   [class.input-error-contrat]="mpp.invalid && mpp.touched">
            <span class="currency-suffix">FCFA</span>
          </div>
          @if (mpp.touched && mpp.invalid) {
            <div class="field-error-contrat">
              @if (mpp.hasError('required')) { Champ requis. }
              @else if (mpp.hasError('pattern')) { Format: 1000, 1 000, 1 000.50 }
              @else if (mpp.hasError('maxlength')) { Valeur trop longue. }
            </div>
          }
        </div>

        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Durée (semaines) <span class="required-mark-contrat">*</span>
          </label>
          <input type="number"
                 min="1"
                 max="200"
                 placeholder="62"
                 formControlName="duree_jour"
                 class="field-input-contrat"
                 [class.input-error-contrat]="djour.invalid && djour.touched">
          @if (djour.touched && djour.invalid) {
            <div class="field-error-contrat">
              @if (djour.hasError('required')) { Champ requis. }
              @else if (djour.hasError('min')) { Minimum 1. }
              @else if (djour.hasError('max')) { Maximum 200. }
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Section Dates - VERSION MISE À JOUR avec les nouveaux champs -->
    <div class="form-section-contrat">
      <h6 class="section-label-contrat">Dates et congés</h6>

      <!-- Première ligne : 3 champs -->
      <div class="form-grid-3-contrat">
        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Date de signature <span class="required-mark-contrat">*</span>
          </label>
          <input type="date"
                 formControlName="date_signature"
                 class="field-input-contrat"
                 [class.input-error-contrat]="sig.invalid && sig.touched">
          @if (sig.touched && sig.invalid) {
            <div class="field-error-contrat">
              @if (sig.hasError('required')) { Champ requis. }
              @else if (sig.hasError('pattern')) { Format attendu AAAA-MM-JJ. }
            </div>
          }
        </div>

        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Date de début <span class="required-mark-contrat">*</span>
          </label>
          <input type="date"
                 formControlName="date_debut"
                 class="field-input-contrat"
                 [class.input-error-contrat]="(deb.invalid && deb.touched) || form.hasError('dateOrder')">
          @if (deb.touched && deb.invalid) {
            <div class="field-error-contrat">
              @if (deb.hasError('required')) { Champ requis. }
              @else if (deb.hasError('pattern')) { Format attendu AAAA-MM-JJ. }
            </div>
          }
          @if (form.hasError('dateOrder')) {
            <div class="field-error-contrat">La date de début doit être postérieure ou égale à la date de signature.</div>
          }
        </div>

        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Jours de congé total <span class="required-mark-contrat">*</span>
          </label>
          <input type="number"
                 formControlName="jour_conge_total"
                 class="field-input-contrat"
                 min="0" max="200"
                 placeholder="30"
                 [class.input-error-contrat]="conge.invalid && conge.touched">
          @if (conge.touched && conge.invalid) {
            <div class="field-error-contrat">
              @if (conge.hasError('required')) { Champ requis. }
              @else if (conge.hasError('min')) { Minimum 0. }
              @else if (conge.hasError('max')) { Maximum 200. }
            </div>
          }
        </div>
      </div>

      <!-- Deuxième ligne : 2 nouveaux champs pour les paiements lease -->
      <div class="form-grid-2-contrat mt-3">
        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Date concernée paiement lease
          </label>
          <input type="date"
                 formControlName="date_concernee"
                 class="field-input-contrat"
                 [class.input-error-contrat]="conc.invalid && conc.touched">
          @if (conc.touched && conc.invalid) {
            <div class="field-error-contrat">
              @if (conc.hasError('pattern')) { Format attendu AAAA-MM-JJ. }
            </div>
          }
        </div>

        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Date limite paiement lease
          </label>
          <input type="date"
                 formControlName="date_limite"
                 class="field-input-contrat"
                 [class.input-error-contrat]="lim.invalid && lim.touched">
          @if (lim.touched && lim.invalid) {
            <div class="field-error-contrat">
              @if (lim.hasError('pattern')) { Format attendu AAAA-MM-JJ. }
            </div>
          }
        </div>
      </div>
    </div>


    <!-- Section Documents -->
    <div class="form-section-contrat">
      <h6 class="section-label-contrat">Documents contractuels</h6>

      <div class="form-grid-3-contrat">
        <!-- Contrat Chauffeur -->
        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Contrat physique (chauffeur) <span class="required-mark-contrat">*</span>
          </label>
          @if (mode() === 'edit' && data?.contrat?.contrat_physique_chauffeur) {
            <div class="existing-file-contrat">
              <i class="fas fa-paperclip me-1"></i>
              <a [href]="data?.contrat?.contrat_physique_chauffeur" target="_blank">
                Voir fichier Chauffeur
              </a>
            </div>
          }
          <div class="file-upload-compact-contrat">
            <input type="file"
                   accept=".pdf,.doc,.docx,image/*"
                   multiple
                   class="file-input-hidden-contrat"
                   id="file-chauffeur-contrat"
                   (change)="onFileChange('contrat_physique_chauffeur', $event)">
            <label for="file-chauffeur-contrat" class="file-upload-btn-contrat required-file-contrat">
              <i class="fas fa-file-contract me-1"></i>
              Chauffeur
            </label>
          </div>
          @if (uploading()['contrat_physique_chauffeur']) {
            <div class="upload-status-contrat">
              <i class="fas fa-spinner fa-spin me-1"></i>
              Upload...
            </div>
          }
          @if (uploadError()['contrat_physique_chauffeur']) {
            <div class="field-error-contrat">{{ uploadError()['contrat_physique_chauffeur'] }}</div>
          }
          @if (physChauff.value) {
            <div class="file-list-compact-contrat">

                <div class="file-item-compact-contrat">
                  <span class="file-name-contrat">{{ physChauff.value.name }}</span>
                  <button type="button" class="file-remove-contrat" (click)="clearFile('contrat_physique_chauffeur')">
                    <i class="fas fa-times"></i>
                  </button>
                </div>

            </div>
          }
          @if (physChauff.invalid && (physChauff.touched || form.touched)) {
            <div class="field-error-contrat">Fichier requis.</div>
          }
        </div>

        <!-- Contrat Moto/Garant -->
        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Contrat physique (garant) <span class="required-mark-contrat">*</span>
          </label>
          @if (mode() === 'edit' && data?.contrat?.contrat_physique_moto_garant) {
            <div class="existing-file-contrat">
              <i class="fas fa-paperclip me-1"></i>
              <a [href]="data?.contrat?.contrat_physique_moto_garant" target="_blank">
                Voir fichier Moto/Garant
              </a>
            </div>
          }
          <div class="file-upload-compact-contrat">
            <input type="file"
                   accept=".pdf,.doc,.docx,image/*"
                   multiple
                   class="file-input-hidden-contrat"
                   id="file-moto-contrat"
                   (change)="onFileChange('contrat_physique_moto_garant', $event)">
            <label for="file-moto-contrat" class="file-upload-btn-contrat required-file-contrat">
              <i class="fas fa-motorcycle me-1"></i>
              Moto/Garant
            </label>
          </div>
          @if (uploading()['contrat_physique_moto_garant']) {
            <div class="upload-status-contrat">
              <i class="fas fa-spinner fa-spin me-1"></i>
              Upload...
            </div>
          }
          @if (uploadError()['contrat_physique_moto_garant']) {
            <div class="field-error-contrat">{{ uploadError()['contrat_physique_moto_garant'] }}</div>
          }
          @if (physMoto.value)  {
            <div class="file-list-compact-contrat">
                <div class="file-item-compact-contrat">
                  <span class="file-name-contrat">{{ physMoto.value.name }}</span>
                  <button type="button" class="file-remove-contrat" (click)="clearFile('contrat_physique_moto_garant')">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
            </div>
          }
          @if (physMoto.invalid && (physMoto.touched || form.touched)) {
            <div class="field-error-contrat">Fichier requis.</div>
          }
        </div>

        <!-- Contrat Batterie/Garant -->
        <div class="form-field-contrat">
          <label class="field-label-contrat">
            Contrat physique (garant) <span class="required-mark-contrat">*</span>
          </label>
          @if (mode() === 'edit' && data?.contrat?.contrat_physique_batt_garant) {
            <div class="existing-file-contrat">
              <i class="fas fa-paperclip me-1"></i>
              <a [href]="data?.contrat?.contrat_physique_batt_garant" target="_blank">
                Voir fichier Batt/Garant
              </a>
            </div>
          }
          <div class="file-upload-compact-contrat">
            <input type="file"
                   accept=".pdf,.doc,.docx,image/*"
                   multiple
                   class="file-input-hidden-contrat"
                   id="file-batt-contrat"
                   (change)="onFileChange('contrat_physique_batt_garant', $event)">
            <label for="file-batt-contrat" class="file-upload-btn-contrat required-file-contrat">
              <i class="fas fa-battery-full me-1"></i>
              Batt/Garant
            </label>
          </div>
          @if (uploading()['contrat_physique_batt_garant']) {
            <div class="upload-status-contrat">
              <i class="fas fa-spinner fa-spin me-1"></i>
              Upload...
            </div>
          }
          @if (uploadError()['contrat_physique_batt_garant']) {
            <div class="field-error-contrat">{{ uploadError()['contrat_physique_batt_garant'] }}</div>
          }
          @if (physBatt.value) {
            <div class="file-list-compact-contrat">
                <div class="file-item-compact-contrat">
                  <span class="file-name-contrat">{{ physMoto.value?.name }}</span>
                  <button type="button" class="file-remove-contrat" (click)="clearFile('contrat_physique_batt_garant')">
                    <i class="fas fa-times"></i>
                  </button>
                </div>

            </div>
          }
          @if (physBatt.invalid && (physBatt.touched || form.touched)) {
            <div class="field-error-contrat">Fichier requis.</div>
          }
        </div>
      </div>
    </div>
  </form>

  <div class="modal-footer-contrat">
    <button type="button" class="btn-cancel-contrat" (click)="cancel()">
      <i class="fas fa-times me-1"></i>
      Annuler
    </button>
    <button type="button"
            class="btn-save-contrat"
            (click)="submit()"
            [disabled]="isSubmitting() || form.invalid">
      @if (isSubmitting()) {
        <span class="spinner-border spinner-border-sm me-1"></span>
        {{ mode() === 'edit' ? 'Mise à jour...' : 'Enregistrement...' }}
      } @else {
        <i class="fas" [class.fa-edit]="mode() === 'edit'" [class.fa-save]="mode() !== 'edit'"></i>
        {{ mode() === 'edit' ? 'Mettre à jour' : 'Enregistrer' }}
      }
    </button>
  </div>
</div>

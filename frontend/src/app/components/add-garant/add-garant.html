

<div class="modal-container-garant">
  <div class="modal-header-garant">
    <h4 class="modal-title-garant" >
      <i class="fas me-2" [ngClass]="mode()==='create' ? 'fa-user-plus': 'fa-edit'"></i>
      {{ mode() === 'create' ? 'Enregistrement d\'un garant' : 'Modification du garant' }}
    </h4>
    <button type="button" class="btn-close-garant" (click)="cancel()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- on peut aussi faire (ngSubmit)="submit()" et mettre type="submit" sur le bouton -->
  <form class="modal-content-garant" [formGroup]="form">
    @if (submitError()) {
      <div class="submit-error mt-2 text-center text-danger">
        {{ submitError() }}
      </div>
    }

    <!-- Section Identité -->
    <div class="form-section-garant">
      <h6 class="section-label">Identité</h6>

      <div class="form-grid-3">
        <div class="form-field">
          <label class="field-label">
            Nom <span class="required-mark">*</span>
          </label>
          <input class="field-input"
                 formControlName="nom"
                 placeholder="NOM"
                 [class.input-error]="nom.invalid && nom.touched"
                 autocomplete="off">
          @if (nom.touched && nom.invalid) {
            <div class="field-error">
              @if (nom.hasError('required')) { Le nom est obligatoire. }
              @else if (nom.hasError('minlength')) { Trop court. }
              @else if (nom.hasError('maxlength')) { Trop long. }
              @else if (nom.hasError('pattern'))   { Caractères non autorisés. }
            </div>
          }
        </div>

        <div class="form-field">
          <label class="field-label">Prénom</label>
          <input class="field-input"
                 formControlName="prenom"
                 placeholder="Prénom"
                 [class.input-error]="prenom.invalid && prenom.touched"
                 autocomplete="off">
          @if (prenom.touched && prenom.invalid) {
            <div class="field-error">
              @if (prenom.hasError('minlength')) { Trop court. }
              @else if (prenom.hasError('maxlength')) { Trop long. }
              @else if (prenom.hasError('pattern'))   { Caractères non autorisés. }
            </div>
          }
        </div>

        <div class="form-field">
          <label class="field-label">Téléphone</label>
          <input class="field-input"
                 formControlName="tel"
                 placeholder="699000000"
                 inputmode="numeric"
                 autocomplete="off"
                 [class.input-error]="tel.invalid && tel.touched">
          @if (tel.touched && tel.invalid) {
            <div class="field-error">Format téléphone invalide.</div>
          }
        </div>
      </div>
    </div>

    <!-- Section Localisation -->
    <div class="form-section-garant">
      <h6 class="section-label">Localisation</h6>

      <div class="form-grid-3">
        <div class="form-field">
          <label class="field-label">
            Ville <span class="required-mark">*</span>
          </label>
          <input class="field-input"
                 formControlName="ville"
                 placeholder="Ville"
                 [class.input-error]="ville.invalid && ville.touched"
                 autocomplete="off">
          @if (ville.touched && ville.invalid) {
            <div class="field-error">
              @if (ville.hasError('required')) { Ville obligatoire. }
              @else if (ville.hasError('minlength')) { Trop court. }
              @else if (ville.hasError('maxlength')) { Trop long. }
              @else if (ville.hasError('pattern'))   { Caractères non autorisés. }
            </div>
          }
        </div>

        <div class="form-field">
          <label class="field-label">
            Quartier <span class="required-mark">*</span>
          </label>
          <input class="field-input"
                 formControlName="quartier"
                 placeholder="Quartier"
                 [class.input-error]="quartier.invalid && quartier.touched"
                 autocomplete="off">
          @if (quartier.touched && quartier.invalid) {
            <div class="field-error">
              @if (quartier.hasError('required')) { Quartier obligatoire. }
              @else if (quartier.hasError('minlength')) { Trop court. }
              @else if (quartier.hasError('maxlength')) { Trop long. }
              @else if (quartier.hasError('pattern'))   { Caractères non autorisés. }
            </div>
          }
        </div>

        <div class="form-field">
          <label class="field-label">Profession</label>
          <input class="field-input"
                 formControlName="profession"
                 placeholder="Profession"
                 [class.input-error]="profession.invalid && profession.touched"
                 autocomplete="off">
          @if (profession.touched && profession.invalid) {
            <div class="field-error">
              @if (profession.hasError('minlength')) { Trop court. }
              @else if (profession.hasError('maxlength')) { Trop long. }
              @else if (profession.hasError('pattern'))   { Caractères non autorisés. }
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Section Documents -->
    <div class="form-section-garant">
      <h6 class="section-label">Documents</h6>

      <div class="form-grid-2">

        <!-- Photo (1 fichier) -->
        <div class="form-field">
          <label class="field-label">Photo</label>
          <div class="file-upload-compact">
            <input type="file"
                   class="file-input-hidden"
                   accept=".pdf,.doc,.docx,image/*"
                   id="photo-input"
                   (change)="onFileChange('photo', $event)">
            <label for="photo-input" class="file-upload-btn">
              <i class="fas fa-camera me-1"></i>
              Choisir un fichier
            </label>
          </div>
          @if (uploading()['photo']) {
            <div class="upload-status"><i class="fas fa-spinner fa-spin me-1"></i> Sélection...</div>
          }
          @if (uploadError()['photo']) {
            <div class="field-error">{{ uploadError()['photo'] }}</div>
          }
          @if (files()['photo']) {
            <div class="file-item-compact">
              <span class="file-name">{{ files()['photo']?.name }}</span>
              <button type="button" class="file-remove" (click)="clearFile('photo')">
                <i class="fas fa-times"></i>
              </button>
            </div>
          }
        </div>

        <!-- Plan de localisation (1 fichier) -->
        <div class="form-field">
          <label class="field-label">Plan de localisation</label>
          <div class="file-upload-compact">
            <input type="file"
                   class="file-input-hidden"
                   accept=".pdf,.doc,.docx,image/*"
                   id="plan-input"
                   (change)="onFileChange('plan_localisation', $event)">
            <label for="plan-input" class="file-upload-btn">
              <i class="fas fa-map me-1"></i>
              Choisir un fichier
            </label>
          </div>
          @if (uploading()['plan_localisation']) {
            <div class="upload-status"><i class="fas fa-spinner fa-spin me-1"></i> Sélection...</div>
          }
          @if (uploadError()['plan_localisation']) {
            <div class="field-error">{{ uploadError()['plan_localisation'] }}</div>
          }
          @if (files()['plan_localisation']) {
            <div class="file-item-compact">
              <span class="file-name">{{ files()['plan_localisation']?.name }}</span>
              <button type="button" class="file-remove" (click)="clearFile('plan_localisation')">
                <i class="fas fa-times"></i>
              </button>
            </div>
          }
        </div>

        <!-- Justificatif d'activité (obligatoire) -->
        <div class="form-field">
          <label class="field-label">
            Justificatif d'activité <span class="required-mark">*</span>
          </label>
          <div class="file-upload-compact">
            <input type="file"
                   class="file-input-hidden"
                   accept=".pdf,.doc,.docx,image/*"
                   id="justif-input"
                   (change)="onFileChange('justif_activite', $event)">
            <label for="justif-input" class="file-upload-btn required-file">
              <i class="fas fa-file-alt me-1"></i>
              Choisir un fichier
            </label>
          </div>
          @if (uploading()['justif_activite']) {
            <div class="upload-status">
              <i class="fas fa-spinner fa-spin me-1"></i> Sélection...
            </div>
          }
          @if (uploadError()['justif_activite']) {
            <div class="field-error">{{ uploadError()['justif_activite'] }}</div>
          }
          @if (files()['justif_activite']) {
            <div class="file-item-compact">
              <span class="file-name">{{ files()['justif_activite']?.name }}</span>
              <button type="button" class="file-remove" (click)="clearFile('justif_activite')">
                <i class="fas fa-times"></i>
              </button>
            </div>
          }
          <!-- Message d'obligation si pas de fichier choisi -->
          @if (!files()['justif_activite'] && form.touched) {
            <div class="field-error">Le justificatif d'activité est obligatoire.</div>
          }
        </div>

        <!-- CNI (Recto/Verso) -->
        <div class="form-field">
          <label class="field-label">CNI (Recto/Verso)</label>
          <div class="cni-upload-group">
            <div class="file-upload-compact">
              <input type="file"
                     class="file-input-hidden"
                     accept=".pdf,.doc,.docx,image/*"
                     id="cni-recto-input"
                     (change)="onFileChange('cni_recto', $event)">
              <label for="cni-recto-input" class="file-upload-btn small">
                <i class="fas fa-id-card me-1"></i>
                Recto
              </label>
            </div>
            <div class="file-upload-compact">
              <input type="file"
                     class="file-input-hidden"
                     accept=".pdf,.doc,.docx,image/*"
                     id="cni-verso-input"
                     (change)="onFileChange('cni_verso', $event)">
              <label for="cni-verso-input" class="file-upload-btn small">
                <i class="fas fa-id-card me-1"></i>
                Verso
              </label>
            </div>
          </div>

          <div class="cni-files">
            @if (files()['cni_recto']) {
              <div class="cni-section">
                <small class="cni-label">Recto :</small>
                <div class="file-item-compact">
                  <span class="file-name">{{ files()['cni_recto']?.name }}</span>
                  <button type="button" class="file-remove" (click)="clearFile('cni_recto')">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            }
            @if (files()['cni_verso']) {
              <div class="cni-section">
                <small class="cni-label">Verso :</small>
                <div class="file-item-compact">
                  <span class="file-name">{{ files()['cni_verso']?.name }}</span>
                  <button type="button" class="file-remove" (click)="clearFile('cni_verso')">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </form>

  <div class="modal-footer-garant">
    <button type="button" class="btn-cancel-garant" (click)="cancel()">
      <i class="fas fa-times me-1"></i>
      Annuler
    </button>
    <button type="button"
            class="btn-save-garant"
            (click)="submit()"
            [disabled]="form.invalid || !files()['justif_activite'] || isSubmitting()">
      @if (isSubmitting()) {
        <span class="spinner-border spinner-border-sm me-1"></span>
        Enregistrement...
      } @else {
        <i class="fas fa-save me-1"></i>
        Enregistrer
      }
    </button>
  </div>
</div>

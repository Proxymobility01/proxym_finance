
<div class="container-fluid">

  <!-- üü° Barre de recherche -->
  <div class="toolbar">
    <input
      type="text"
      class="search-input"
      placeholder="Rechercher chauffeur (nom / pr√©nom / ID)‚Ä¶"
      [ngModel]="search()"
      (ngModelChange)="onSearchChange($event)"
    />

    <div class="spacer"></div>

    <div class="summary">
      @if (!isLoading() && !error()) {
        <span>Total contrats : {{ count() | number }}</span>
      }
    </div>
  </div>

  <!-- üü¢ √âtats exclusifs -->
  @if (isLoading()) {
    <div class="center-state">
      <div class="spinner-border"></div>
      <p class="state-message">Chargement des calendriers‚Ä¶</p>
    </div>
  } @else if (error()) {
    <div class="center-state">
      <i class="fas fa-exclamation-triangle error-icon"></i>
      <p class="state-message error-text">Erreur lors du chargement</p>
      <p class="state-submessage">{{ error() }}</p>
    </div>
  } @else if (viewModels().length === 0) {
    <div class="center-state">
      <i class="fas fa-calendar-times empty-icon"></i>
      <p class="state-message">Aucun calendrier trouv√©</p>
      <p class="state-submessage">Aucun contrat ne correspond √† votre recherche.</p>
    </div>
  } @else {

    <!-- üîµ Liste des calendriers -->
    @for (vm of viewModels(); track vm.contratId) {
      <section class="contract-card">
        <header class="contract-header">
          <div class="person">
            <div class="name">{{ vm.prenom }} {{ vm.nom }}</div>
            <div class="uid">#{{ vm.userId }}</div>
          </div>

          <div class="year-switch">
            <button (click)="yearMinus(vm.contratId)">‚Üê {{ vm.year - 1 }}</button>
            <div class="year">{{ vm.year }}</div>
            <button (click)="yearPlus(vm.contratId)">{{ vm.year + 1 }} ‚Üí</button>
          </div>

          <div class="legend">
            <span class="dot dot-pay"></span> Pay√©
            <span class="dot dot-off"></span> Cong√©
            <span class="dot dot-multi"></span> Paiement multiple
            <span class="totals">
                Jours pay√©s: <b>{{ vm.totals.payes }}</b> |
                Cong√©s: <b>{{ vm.totals.conges }}</b> |
                Paiements: <b>{{ vm.totals.total_paiements }}</b>
              </span>
          </div>
        </header>

        <!-- üî∂ Grille annuelle -->
        <div class="year-grid">
          @for (month of vm.months; track month.monthIndex) {
            <div class="month">
              <div class="month-title">{{ month.monthLabel }}</div>

              <!-- En-t√™tes semaine -->
              <div class="week-header">
                @for (lbl of weekLabels; track lbl) {
                  <div class="cell head">{{ lbl }}</div>
                }
              </div>

              <!-- Semaines -->
              @for (week of month.weeks; track $index) {
                <div class="week-row">
                  @for (cell of week; track $index) {
                    <div
                      class="cell day"
                      [class.empty]="!cell.d"
                      [class.paid]="cell.isPaid && !cell.isMultiple"
                      [class.off]="cell.isOff"
                      [class.sun]="cell.isSunday"
                      [class.today]="cell.isToday"
                      [class.multi]="cell.isMultiple"
                      title="{{ cell.iso || '' }}"
                    >
                        <span class="day-num">
                          {{ cell.d || '' }}
                          @if (cell.isPaid && cell.paiementCount) {
                            <span class="multi">x{{ cell.paiementCount }}</span>
                          }
                        </span>
                    </div>

                  }
                </div>
              }
            </div>
          }
        </div>
      </section>
    }

    <!-- Infinite scroll anchor -->
    <div #infiniteAnchor class="infinite-anchor"></div>
  }
</div>
